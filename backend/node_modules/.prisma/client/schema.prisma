// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ── Session Model ───────────────────────────────────────────
model Session {
  id        String  @id @default(cuid())
  token     String  @unique // Generated via crypto.randomBytes in createSession()
  userId    String?
  role      String  @default("user") // "user" | "admin"
  language  String  @default("hi")
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  expiresAt DateTime

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// ── User Model ──────────────────────────────────────────────
model User {
  id       String  @id @default(cuid())
  phone    String? @unique
  email    String? @unique
  name     String?
  role     String  @default("user") // "user" | "admin"
  active   Boolean @default(true)
  language String  @default("hi") // "hi" | "en"

  // Location
  village  String?
  district String?
  state    String?
  pincode  String?

  // Demographics
  age        Int?
  gender     String? // "male" | "female" | "other"
  category   String? // "General" | "SC" | "ST" | "OBC" | "Minority"
  income     Int?
  occupation String?

  // Preferences
  favoriteModules String[] @default([])
  voiceEnabled    Boolean  @default(true)
  fontSize        String   @default("normal")

  // Timestamps
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  // Relations
  sessions      Session[]
  conversations Conversation[]
  analytics     AnalyticsEvent[]

  @@map("users")
}

// ── Conversation Model ──────────────────────────────────────
model Conversation {
  id           String  @id @default(cuid())
  userId       String?
  mode         String // "janseva" | "janshiksha" | "jankrishi" | "janvyapar" | "jankaushal"
  satisfaction Int? // 1-5 rating
  resolved     Boolean @default(false)

  startedAt DateTime  @default(now())
  endedAt   DateTime?

  // Relations
  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages Message[]

  @@index([userId])
  @@index([mode])
  // Composite index for findActiveConversation: WHERE userId + mode + endedAt IS NULL + startedAt
  @@index([userId, mode, endedAt, startedAt(sort: Desc)])
  @@map("conversations")
}

// ── Message Model ───────────────────────────────────────────
model Message {
  id             String  @id @default(cuid())
  conversationId String
  role           String // "user" | "assistant" | "system"
  content        String
  intent         String?
  confidence     Float?
  responseTimeMs Int?

  timestamp DateTime @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

// ── Analytics Event Model ───────────────────────────────────
model AnalyticsEvent {
  id        String  @id @default(cuid())
  type      String // "page_view" | "mode_select" | "voice_start" | etc.
  userId    String?
  mode      String?
  metadata  Json    @default("{}")
  sessionId String

  timestamp DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([userId])
  @@index([timestamp])
  @@map("analytics_events")
}

// ── OTP Verification Model ─────────────────────────────────
model OtpVerification {
  id         String   @id @default(cuid())
  identifier String // phone number or email
  otpHash    String // SHA-256 hash — NEVER store plain text
  expiresAt  DateTime
  verified   Boolean  @default(false)
  attempts   Int      @default(0) // brute-force tracking

  createdAt DateTime @default(now())

  @@index([identifier, expiresAt])
  @@index([identifier, createdAt])
  @@map("otp_verifications")
}

// ── Daily Snapshot Model (pre-aggregated analytics) ─────────
model DailySnapshot {
  id                 String   @id @default(cuid())
  date               DateTime @unique // The day this snapshot covers (midnight UTC)
  totalUsers         Int      @default(0)
  activeUsers        Int      @default(0)
  totalConversations Int      @default(0)
  newConversations   Int      @default(0)
  avgResponseTimeMs  Int      @default(0)
  satisfactionAvg    Float    @default(0)
  resolvedRate       Int      @default(0) // percentage 0-100
  moduleUsage        Json     @default("{}")
  languageSplit      Json     @default("{}")
  topIntents         Json     @default("[]")

  computedAt DateTime @default(now())

  @@index([date])
  @@map("daily_snapshots")
}
